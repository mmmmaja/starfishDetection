# Training

## Environment
Create a dedicated environment to keep track of the packages for the project
```bash
conda create --name starfish-env python=3.11
conda activate starfish-env
pip install -r requirements.txt
pip install -r requirements_dev.txt
pip install -e .
```

## Data
Download the data for the project from our Google Cloud Bucket, which requires the Google Cloud SDK
```bash
invoke download-data
```

## Train
Train with default arguments
```bash
train
```
Train with data downloaded from the bucket rather than accessing it directly from the cloud
```bash
train data.data_from_bucket=false
```

## Profiling
Train with profiling
```bash
train profiling=True
```
Profile forward pass
```bash
invoke profile-forward-pass
```

## Docker
Build the training dockerfile into a Docker image
```bash
invoke build-train-image
```
Run a container spawned from the docker image
```bash
invoke run-train-image
```
Build an image for the backend and push it to the cloud
```bash
invoke backend-image-to-cloud
```
Build an image for the frontend and push it to the cloud
```bash
invoke frontend-image-to-cloud
```
Test a docker image locally
```bash
docker run --rm -p 8080:8080 -e "PORT=8080" IMAGE_NAME
```
Deploy the backend
```bash
invoke deploy-backend
```
Deploy the frontend
```bash
invoke deploy-frontend
```


## Vertex AI
Get the Docker image built from `train.dockerfile` in the Artifact Registry on Google Cloud, for example by creating a trigger and using the `cloudbuild.yaml` file. Then you can train a model using that Docker image through the Vertex AI service. This also automatically logs the training to Wandb if your API key has been stored as a secret in Google Cloud.
```bash
invoke train-vertex
```

## Wandb
Login
```bash
wandb login
```
Hyperparameter sweep
```bash
invoke sweep
wandb agent ENTITY/PROJECT_NAME/AGENT_ID
```

## Deploy application
Deploy the application by running the backend and frontend Docker images in the Artifact Registry generated by the Cloud Build trigger and `cloudbuild.yaml`.
```bash
gcloud run deploy backend --image=us-central1-docker.pkg.dev/starfish-detection/frontend-backend/backend:latest --region=us-central1 --platform=managed --allow-unauthenticated --port=8080
gcloud run deploy frontend --image=us-central1-docker.pkg.dev/starfish-detection/frontend-backend/frontend:latest --region=us-central1 --platform=managed --allow-unauthenticated --port=8080
```

## Tests
Run all tests and calculate coverage
```bash
invoke test
```
Run data tests
```bash
invoke test-data
```
Run model tests
```bash
invoke test-model
```
Load test
```bash
locust -f tests/performancetests/locustfile.py --headless --users 10 --spawn-rate 1 --run-time 1m --host https://backend-638730968773.us-central1.run.app
```

## Documentation Site
Build site locally
```bash
mkdocs build
```
Deploy site to `gh-pages` branch
```bash
mkdocs gh-deploy
```
